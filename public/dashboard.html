<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Council Dashboard - COVBudget 2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gold: #FFD700;
            --secondary-gold: #FFA500;
            --dark-gold: #B8860B;
            --light-gold: #FFFFE0;
            --black: #000000;
            --dark-black: #1a1a1a;
            --medium-black: #2d2d2d;
            --light-black: #404040;
            --text-light: #FFFFFF;
            --text-gold: #FFD700;
            --text-muted: #CCCCCC;
            --accent-gold: #DAA520;
            --success-gold: #FFD700;
            --warning-gold: #FFA500;
            --error-red: #FF4444;
            --gradient-primary: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            --gradient-bg: linear-gradient(135deg, var(--black) 0%, var(--dark-black) 50%, var(--medium-black) 100%);
            --gradient-card: linear-gradient(145deg, var(--dark-black), var(--medium-black));
            --border-radius: 12px;
            --shadow-md: 0 4px 16px rgba(255, 215, 0, 0.15);
            --shadow-gold: 0 4px 16px rgba(255, 215, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient-bg);
            color: var(--text-light);
            line-height: 1.6;
            width: 100%;
            overflow-x: hidden;
        }

        .dashboard-container {
            padding: 2rem 1rem;
            min-height: 100vh;
            max-width: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        .dashboard-header {
            background: var(--gradient-card);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dashboard-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .tab-navigation {
            display: flex;
            background: var(--dark-black);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-gold);
            overflow-x: auto;
            flex-wrap: wrap;
            gap: 0.25rem;
            border: 1px solid var(--dark-gold);
        }

        .tab-button {
            flex: 0 0 auto;
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            white-space: nowrap;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 215, 0, 0.1);
            color: var(--primary-gold);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--gradient-card);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-gold);
            border: 1px solid var(--dark-gold);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            border-color: var(--primary-gold);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-icon {
            font-size: 2rem;
            color: var(--primary-gold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary-gold);
            color: var(--primary-gold);
        }

        .btn-secondary:hover {
            background: var(--primary-gold);
            color: var(--black);
        }

        .account-list {
            list-style: none;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-gold);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .account-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        .bank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 215, 0, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .bank-info h4 {
            color: var(--text-light);
            margin: 0 0 0.25rem 0;
        }

        .bank-info p {
            color: var(--text-muted);
            margin: 0;
            font-size: 0.9rem;
        }

        .bank-actions {
            display: flex;
            gap: 0.5rem;
        }

        .account-info h4 {
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .account-info p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .account-balance {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-gold);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .account-type-section {
            margin-bottom: 2rem;
        }

        .account-type-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 215, 0, 0.1);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-gold);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .account-type-icon {
            font-size: 1.25rem;
            color: var(--primary-gold);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .account-type-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
            margin: 0;
        }

        .account-type-count {
            font-size: 0.9rem;
            color: var(--black);
            background: var(--primary-gold);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            margin-left: auto;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed var(--primary-gold);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 215, 0, 0.05);
        }

        .upload-area:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--secondary-gold);
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.2);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-gold);
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .table-container {
            background: var(--dark-black);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-gold);
            border: 1px solid var(--dark-gold);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }

        .table th {
            background: var(--gradient-primary);
            color: var(--black);
            font-weight: 600;
        }

        .table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .category-select {
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--dark-gold);
            background: var(--dark-black);
            color: var(--text-light);
        }

        .budget-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            color: var(--text-light);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--dark-gold);
            background: var(--dark-black);
            color: var(--text-light);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }

        .chart-container {
            height: 400px;
            margin: 2rem 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px 0.5rem 2rem;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .dashboard-header {
                padding: 1rem;
                margin: 0 0.5rem 1rem;
            }
            
            .dashboard-title {
                font-size: 1.8rem;
                line-height: 1.2;
                word-wrap: break-word;
            }
            
            .dashboard-subtitle {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .tab-navigation {
                flex-wrap: wrap;
                margin: 0 0.5rem 1rem;
                padding: 0.25rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-button {
                flex: 0 0 auto;
                min-width: 100px;
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin: 0 0.5rem 1rem;
            }
            
            .card {
                padding: 1rem;
                margin: 0;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .card-title {
                font-size: 1.1rem;
                line-height: 1.3;
            }
            
            .budget-form {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .form-group input,
            .form-group select {
                width: 100%;
                box-sizing: border-box;
            }
            
            .btn {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .account-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .account-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .account-balance {
                font-size: 1.2rem;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table {
                min-width: 600px;
            }
            
            .table th,
            .table td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .upload-area {
                padding: 1rem;
            }
            
            .upload-icon {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .metric-value {
                font-size: 1.8rem;
            }
            
            .tab-button {
                min-width: 80px;
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .card {
                padding: 0.75rem;
            }
            
            .account-type-header {
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-tachometer-alt"></i> Council Financial Dashboard
            </h1>
            <p class="dashboard-subtitle">
                Comprehensive financial management and analytics for council operations
            </p>
        </div>

        <div class="tab-navigation" id="mainTabNavigation">
            <button class="tab-button active" onclick="switchTab('analytics')">
                <i class="fas fa-chart-line"></i> Analytics
            </button>
            <button class="tab-button" onclick="switchTab('add-account')">
                <i class="fas fa-plus"></i> Add Account
            </button>
            <!-- Bank tabs will be dynamically added here -->
            <button class="tab-button" onclick="switchTab('transactions')">
                <i class="fas fa-list"></i> Transactions
            </button>
            <button class="tab-button" onclick="switchTab('estimated-budget')">
                <i class="fas fa-calculator"></i> Estimated Budget
            </button>
            <button class="tab-button" onclick="switchTab('actual-budget')">
                <i class="fas fa-edit"></i> Actual Budget
            </button>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content active">
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-dollar-sign card-icon"></i>
                        <h3 class="card-title">Total Balance</h3>
                    </div>
                    <div class="metric-value" id="totalBalance">$0.00</div>
                    <div class="metric-label">Across all accounts</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-arrow-up card-icon"></i>
                        <h3 class="card-title">Monthly Income</h3>
                    </div>
                    <div class="metric-value" id="monthlyIncome">$0.00</div>
                    <div class="metric-label">This month</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-arrow-down card-icon"></i>
                        <h3 class="card-title">Monthly Expenses</h3>
                    </div>
                    <div class="metric-value" id="monthlyExpenses">$0.00</div>
                    <div class="metric-label">This month</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie card-icon"></i>
                        <h3 class="card-title">Budget Variance</h3>
                    </div>
                    <div class="metric-value" id="budgetVariance">0%</div>
                    <div class="metric-label">vs. planned budget</div>
                </div>
            </div>
            
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line card-icon"></i>
                        <h3 class="card-title">Spending Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie card-icon"></i>
                        <h3 class="card-title">Category Breakdown</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Account Tab -->
        <div id="add-account" class="tab-content">
            <!-- Add New Bank Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-university card-icon"></i>
                    <h3 class="card-title">Create New Bank</h3>
                </div>
                <div class="budget-form">
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="newBankName" placeholder="e.g., Wells Fargo">
                    </div>
                    <div class="form-group">
                        <label>Bank Description (Optional)</label>
                        <input type="text" id="newBankDescription" placeholder="e.g., Primary banking partner">
                    </div>
                </div>
                <button class="btn" onclick="createBank()">
                    <i class="fas fa-plus"></i> Create Bank
                </button>
            </div>

            <!-- Add New Account Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-plus card-icon"></i>
                    <h3 class="card-title">Add New Account</h3>
                </div>
                <div class="budget-form">
                    <div class="form-group">
                        <label>Select Bank</label>
                        <select id="bankSelect">
                            <option value="">Choose a bank...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Type</label>
                        <select id="accountType">
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                            <option value="credit">Credit Card</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Name</label>
                        <input type="text" id="accountName" placeholder="e.g., Primary Checking">
                    </div>
                    <div class="form-group">
                        <label>Initial Balance</label>
                        <input type="number" id="initialBalance" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <button class="btn" onclick="addAccount()">
                    <i class="fas fa-plus"></i> Add Account
                </button>
            </div>

            <!-- Manage Banks Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cogs card-icon"></i>
                    <h3 class="card-title">Manage Banks</h3>
                </div>
                <div id="banksList">
                    <!-- Banks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Dynamic Bank Tabs will be inserted here -->
        <div id="bankTabsContainer">
            <!-- Bank-specific tabs will be dynamically created -->
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-filter card-icon"></i>
                    <h3 class="card-title">Filter Transactions</h3>
                </div>
                <div class="budget-form">
                    <div class="form-group">
                        <label>Account</label>
                        <select id="filterAccount">
                            <option value="">All Accounts</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="filterDateFrom">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="filterDateTo">
                    </div>
                </div>
                <button class="btn" onclick="filterTransactions()">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Account</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Estimated Budget Tab -->
        <div id="estimated-budget" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-plus card-icon"></i>
                    <h3 class="card-title">Add Budget Category</h3>
                </div>
                <div class="budget-form">
                    <div class="form-group">
                        <label>Category Name</label>
                        <input type="text" id="budgetCategoryName" placeholder="e.g., Office Supplies">
                    </div>
                    <div class="form-group">
                        <label>Monthly Budget</label>
                        <input type="number" id="budgetAmount" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <button class="btn" onclick="addBudgetCategory()">
                    <i class="fas fa-plus"></i> Add Category
                </button>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Budgeted Amount</th>
                            <th>Actual Spent</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="budgetTableBody">
                        <!-- Budget categories will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Actual Budget Tab -->
        <div id="actual-budget" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-edit card-icon"></i>
                    <h3 class="card-title">Manage Transaction Categories</h3>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">
                    Review and modify the category assignments for your transactions. Changes will affect budget calculations.
                </p>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Current Category</th>
                            <th>New Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="actualBudgetTableBody">
                        <!-- Transactions for category editing will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let accounts = [];
        let transactions = [];
        let budgetCategories = [];
        let charts = {};
        let banks = new Set(); // Track available banks

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        // Tab switching
        function switchTab(tabName, clickedButton = null) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the button that corresponds to this tab
                const tabButton = document.querySelector(`[onclick*="switchTab('${tabName}')"], [onclick*="switchTab(\`${tabName}\`)"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            // Load tab-specific data
            loadTabData(tabName);
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                let token = localStorage.getItem('authToken');
                
                // For development, use a mock token if no token exists
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }
                
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                // Load accounts
                const accountsResponse = await fetch('/api/accounts', { headers });
                if (accountsResponse.ok) {
                    accounts = await accountsResponse.json();
                    updateBanksFromAccounts();
                    createBankTabs();
                    updateFilterSelects();
                    updateBankSelector();
                    updateBanksList();
                }
                
                // Load transactions
                const transactionsResponse = await fetch('/api/transactions', { headers });
                if (transactionsResponse.ok) {
                    transactions = await transactionsResponse.json();
                    updateTransactionsUI();
                }
                
                // Load budget categories
                const budgetResponse = await fetch('/api/budget-categories', { headers });
                if (budgetResponse.ok) {
                    budgetCategories = await budgetResponse.json();
                    updateBudgetUI();
                }
                
                // Update analytics
                updateAnalytics();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showMessage('Error loading dashboard data', 'error');
            }
        }

        // Load tab-specific data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'analytics':
                    updateAnalytics();
                    break;
                case 'add-account':
                    // No specific loading needed for add account tab
                    break;
                case 'transactions':
                    updateTransactionsUI();
                    break;
                case 'estimated-budget':
                    updateBudgetUI();
                    break;
                case 'actual-budget':
                    updateActualBudgetUI();
                    break;
                default:
                    // Check if it's a bank tab
                    if (tabName.startsWith('bank-')) {
                        updateBankTabContent(tabName);
                    }
                    break;
            }
        }

        // Account management
        async function addAccount() {
            const name = document.getElementById('accountName').value;
            const type = document.getElementById('accountType').value;
            const bankName = document.getElementById('bankSelect').value;
            const balance = parseFloat(document.getElementById('initialBalance').value) || 0;
            
            if (!name || !type || !bankName) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                let token = localStorage.getItem('authToken');
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }
                
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        type,
                        bank_name: bankName,
                        balance
                    })
                });
                
                if (response.ok) {
                    showMessage('Account added successfully', 'success');
                    
                    // Switch to the bank tab for the newly added account
                    const bankId = bankName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    
                    // Clear form
                    document.getElementById('accountName').value = '';
                    document.getElementById('bankSelect').value = '';
                    document.getElementById('initialBalance').value = '';
                    
                    loadDashboardData();
                    setTimeout(() => switchTab(`bank-${bankId}`), 500);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add account');
                }
            } catch (error) {
                showMessage('Error adding account: ' + error.message, 'error');
            }
        }

        // Global variable to store the selected file
        let selectedFiles = {};

        // Preview file before upload
        async function previewStatementFile(event, bankId) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            // Store the file for later upload
            selectedFiles[bankId] = file;
            
            // Show file name
            document.getElementById(`fileName-${bankId}`).textContent = `📄 ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            // Read and preview file content
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let preview = '';
                
                if (file.name.toLowerCase().endsWith('.csv')) {
                    // Preview CSV content
                    const lines = content.split('\n').slice(0, 10); // Show first 10 lines
                    preview = lines.map((line, index) => {
                        const cols = line.split(',');
                        let displayLine = '';
                        
                        // Highlight Wells Fargo format columns
                        cols.forEach((col, colIndex) => {
                            const colLetter = String.fromCharCode(65 + colIndex); // A, B, C, D, E...
                            let cellClass = '';
                            
                            if (colLetter === 'A' && index >= 0) { // Date column
                                cellClass = 'style="color: var(--primary-gold); font-weight: bold;"';
                            } else if (colLetter === 'B' && index >= 1) { // Amount column
                                cellClass = 'style="color: var(--secondary-gold); font-weight: bold;"';
                            } else if (colLetter === 'E' && index >= 0) { // Description column
                                cellClass = 'style="color: var(--text-light); font-weight: bold;"';
                            }
                            
                            displayLine += `<span ${cellClass}>${colLetter}${index + 1}: ${col.trim()}</span>  `;
                        });
                        
                        return `Row ${index + 1}: ${displayLine}`;
                    }).join('\n');
                } else {
                    preview = 'Excel file selected. Content will be processed during upload.';
                }
                
                document.getElementById(`fileContent-${bankId}`).innerHTML = `<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${preview}</pre>`;
                
                // Show preview section
                document.getElementById(`filePreview-${bankId}`).style.display = 'block';
            };
            
            reader.readAsText(file);
        }

        // Process the uploaded file
        async function processStatementUpload(bankId) {
            const file = selectedFiles[bankId];
            const accountId = document.getElementById(`uploadAccountSelect-${bankId}`).value;
            
            if (!file) {
                showMessage('Please select a file to upload', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('statement', file);
            
            // If an account is selected, use it; otherwise let the server create a new one
            if (accountId) {
                formData.append('account_id', accountId);
            } else {
                // Use the bank name as the default account name
                const bankName = Object.keys(getBankGroups()).find(name => 
                    name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') === bankId
                );
                formData.append('account_name', `${bankName} Checking`);
            }
            
            // No need to specify format - using intelligent universal parser
            
            try {
                let token = localStorage.getItem('authToken');
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }
                
                // Show loading status
                document.getElementById(`uploadStatus-${bankId}`).innerHTML = `
                    <div style="color: var(--primary-gold); padding: 1rem; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 1px solid var(--dark-gold);">
                        <i class="fas fa-brain fa-spin"></i> Analyzing ${file.name} with intelligent parser...
                    </div>
                `;
                
                console.log('Uploading file:', file.name);
                console.log('Account ID:', accountId);
                
                const response = await fetch('/api/upload-statement', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                console.log('Upload response:', result);
                
                if (response.ok && result.success) {
                    showMessage(`Statement uploaded successfully! ${result.transactions_count} transactions processed.`, 'success');
                    
                    // Show success status
                    document.getElementById(`uploadStatus-${bankId}`).innerHTML = `
                        <div style="color: var(--success-gold); padding: 1rem; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 1px solid var(--dark-gold);">
                            <i class="fas fa-check-circle"></i> Successfully processed ${result.transactions_count} transactions from ${file.name}
                            <br><small>Account: ${result.accountName} | Date Range: ${result.dateRange}</small>
                        </div>
                    `;
                    
                    // Hide preview and reset
                    cancelFileUpload(bankId);
                    
                    // Refresh dashboard data
                    console.log('Refreshing dashboard data...');
                    await loadDashboardData();
                    
                    // Switch to the bank tab or transactions tab to show results
                    if (result.accountId) {
                        // Try to switch to the bank tab first
                        const bankName = result.accountName ? result.accountName.split(' ')[0] : 'Wells Fargo';
                        const bankTabId = bankName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                        
                        setTimeout(() => {
                            if (document.getElementById(`bank-${bankTabId}`)) {
                                switchTab(`bank-${bankTabId}`);
                            } else {
                                switchTab('transactions');
                            }
                        }, 1000);
                    }
                    
                } else {
                    const errorMessage = result.error || 'Upload failed';
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Upload error: ' + error.message, 'error');
                document.getElementById(`uploadStatus-${bankId}`).innerHTML = `
                    <div style="color: var(--error-red); padding: 1rem; background: rgba(255, 68, 68, 0.1); border-radius: 8px; border: 1px solid var(--error-red);">
                        <i class="fas fa-exclamation-triangle"></i> Upload failed: ${error.message}
                    </div>
                `;
            }
        }

        // Cancel file upload
        function cancelFileUpload(bankId) {
            // Hide preview
            document.getElementById(`filePreview-${bankId}`).style.display = 'none';
            
            // Clear file input
            document.getElementById(`statementUpload-${bankId}`).value = '';
            
            // Clear stored file
            delete selectedFiles[bankId];
            
            // Clear status
            document.getElementById(`uploadStatus-${bankId}`).innerHTML = '';
        }

        // Budget category management
        async function addBudgetCategory() {
            const name = document.getElementById('budgetCategoryName').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value) || 0;
            
            if (!name || amount <= 0) {
                showMessage('Please enter a valid category name and amount', 'error');
                return;
            }
            
            try {
                let token = localStorage.getItem('authToken');
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }
                
                const response = await fetch('/api/budget-categories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        budgeted_amount: amount
                    })
                });
                
                if (response.ok) {
                    showMessage('Budget category added successfully', 'success');
                    document.getElementById('budgetCategoryName').value = '';
                    document.getElementById('budgetAmount').value = '';
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add category');
                }
            } catch (error) {
                showMessage('Error adding category: ' + error.message, 'error');
            }
        }

        // UI Update functions
        function createBankTabs() {
            // Group accounts by bank
            const bankGroups = {};
            accounts.forEach(account => {
                const bankName = account.bank_name || 'Unknown Bank';
                if (!bankGroups[bankName]) {
                    bankGroups[bankName] = [];
                }
                bankGroups[bankName].push(account);
            });

            // Clear existing bank tabs
            const existingBankTabs = document.querySelectorAll('[data-bank-tab]');
            existingBankTabs.forEach(tab => tab.remove());
            
            const existingBankContent = document.querySelectorAll('[data-bank-content]');
            existingBankContent.forEach(content => content.remove());

            // Create tabs for each bank
            const tabNavigation = document.getElementById('mainTabNavigation');
            const transactionsButton = tabNavigation.querySelector('button[onclick="switchTab(\'transactions\')"]');
            const bankTabsContainer = document.getElementById('bankTabsContainer');

            Object.keys(bankGroups).forEach(bankName => {
                const bankId = bankName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                // Create tab button
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.setAttribute('data-bank-tab', bankId);
                tabButton.onclick = () => switchTab(`bank-${bankId}`, tabButton);
                tabButton.innerHTML = `<i class="fas fa-university"></i> ${bankName}`;
                
                // Insert before transactions button
                tabNavigation.insertBefore(tabButton, transactionsButton);

                // Create tab content
                const tabContent = document.createElement('div');
                tabContent.id = `bank-${bankId}`;
                tabContent.className = 'tab-content';
                tabContent.setAttribute('data-bank-content', bankId);
                
                tabContent.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-university card-icon"></i>
                            <h3 class="card-title">${bankName} Accounts</h3>
                        </div>
                        <div id="accountsByType-${bankId}">
                            <!-- Account types will be organized here -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-upload card-icon"></i>
                            <h3 class="card-title">Upload Bank Statement</h3>
                        </div>
                        <div class="form-group">
                            <label>Select Account</label>
                            <select id="uploadAccountSelect-${bankId}">
                                <option value="">Choose an account...</option>
                            </select>
                        </div>
                        <div class="upload-area" onclick="document.getElementById('statementUpload-${bankId}').click()">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h4>Drop your bank statement here</h4>
                            <p>Or click to browse files</p>
                            <small>Supports CSV, Excel (.xlsx, .xls) - Max 10MB</small>
                        </div>
                        <input type="file" id="statementUpload-${bankId}" style="display: none;" accept=".csv,.xlsx,.xls" onchange="previewStatementFile(event, '${bankId}')">
                        
                        <div id="filePreview-${bankId}" style="display: none; margin-top: 1rem;">
                            <div class="card" style="background: rgba(255, 215, 0, 0.05); border: 1px solid var(--dark-gold);">
                                <h4 style="color: var(--primary-gold); margin-bottom: 1rem;">
                                    <i class="fas fa-eye"></i> File Preview
                                </h4>
                                <div id="fileName-${bankId}" style="margin-bottom: 1rem; font-weight: 600;"></div>
                                <div id="fileContent-${bankId}" style="max-height: 300px; overflow-y: auto; background: var(--dark-black); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; border: 1px solid var(--dark-gold);"></div>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <button class="btn" onclick="processStatementUpload('${bankId}')">
                                        <i class="fas fa-upload"></i> Upload & Process
                                    </button>
                                    <button class="btn btn-secondary" onclick="cancelFileUpload('${bankId}')">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="uploadStatus-${bankId}" style="margin-top: 1rem;"></div>
                    </div>
                `;
                
                bankTabsContainer.appendChild(tabContent);
            });

            // Update content for each bank
            Object.keys(bankGroups).forEach(bankName => {
                const bankId = bankName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                updateBankTabContent(`bank-${bankId}`);
            });
        }

        function updateBankTabContent(tabName) {
            const bankId = tabName.replace('bank-', '');
            const bankName = Object.keys(getBankGroups()).find(name => 
                name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') === bankId
            );
            
            if (!bankName) return;

            const bankAccounts = getBankGroups()[bankName];
            const accountsByTypeContainer = document.getElementById(`accountsByType-${bankId}`);
            const uploadSelect = document.getElementById(`uploadAccountSelect-${bankId}`);
            
            // Group accounts by type
            const accountTypes = {
                checking: { accounts: [], icon: 'fas fa-university', name: 'Checking Accounts' },
                savings: { accounts: [], icon: 'fas fa-piggy-bank', name: 'Savings Accounts' },
                credit: { accounts: [], icon: 'fas fa-credit-card', name: 'Credit Accounts' }
            };

            bankAccounts.forEach(account => {
                const accountType = account.type.toLowerCase();
                if (accountTypes[accountType]) {
                    accountTypes[accountType].accounts.push(account);
                } else {
                    // Handle unknown account types
                    if (!accountTypes.other) {
                        accountTypes.other = { accounts: [], icon: 'fas fa-wallet', name: 'Other Accounts' };
                    }
                    accountTypes.other.accounts.push(account);
                }
            });

            if (accountsByTypeContainer) {
                accountsByTypeContainer.innerHTML = '';
                
                // Create sections for each account type that has accounts
                Object.keys(accountTypes).forEach(typeKey => {
                    const typeData = accountTypes[typeKey];
                    if (typeData.accounts.length > 0) {
                        const section = document.createElement('div');
                        section.className = 'account-type-section';
                        
                        section.innerHTML = `
                            <div class="account-type-header">
                                <i class="${typeData.icon} account-type-icon"></i>
                                <h4 class="account-type-title">${typeData.name}</h4>
                                <span class="account-type-count">${typeData.accounts.length}</span>
                            </div>
                            <ul class="account-list" id="accountsList-${bankId}-${typeKey}">
                            </ul>
                        `;
                        
                        accountsByTypeContainer.appendChild(section);
                        
                        // Add accounts to this type section
                        const accountsList = document.getElementById(`accountsList-${bankId}-${typeKey}`);
                        typeData.accounts.forEach(account => {
                            const li = document.createElement('li');
                            li.className = 'account-item';
                            li.innerHTML = `
                                <div class="account-info">
                                    <h4>${account.name}</h4>
                                    <p>Account #${account.id.slice(-4)} • ${getAccountTypeDisplayName(account.type)}</p>
                                </div>
                                <div class="account-actions">
                                    <div class="account-balance">$${parseFloat(account.balance || 0).toFixed(2)}</div>
                                    <button class="btn btn-secondary btn-small" onclick="deleteAccount('${account.id}', '${account.name}')" title="Delete Account">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            accountsList.appendChild(li);
                        });
                    }
                });
            }

            // Update upload select
            if (uploadSelect) {
                uploadSelect.innerHTML = '<option value="">Choose an account...</option>';
                bankAccounts.forEach(account => {
                    const typeLabel = getAccountTypeDisplayName(account.type);
                    uploadSelect.innerHTML += `<option value="${account.id}">${account.name} (${typeLabel})</option>`;
                });
            }
        }

        function getAccountTypeDisplayName(type) {
            const typeMap = {
                checking: 'Checking',
                savings: 'Savings',
                credit: 'Credit Card'
            };
            return typeMap[type.toLowerCase()] || type;
        }

        // Bank Management Functions
        function updateBanksFromAccounts() {
            banks.clear();
            accounts.forEach(account => {
                if (account.bank_name && account.bank_name.trim()) {
                    banks.add(account.bank_name.trim());
                }
            });
        }

        function updateBankSelector() {
            const bankSelect = document.getElementById('bankSelect');
            if (bankSelect) {
                bankSelect.innerHTML = '<option value="">Choose a bank...</option>';
                Array.from(banks).sort().forEach(bankName => {
                    bankSelect.innerHTML += `<option value="${bankName}">${bankName}</option>`;
                });
            }
        }

        function updateBanksList() {
            const banksList = document.getElementById('banksList');
            if (banksList) {
                banksList.innerHTML = '';
                
                if (banks.size === 0) {
                    banksList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No banks created yet.</p>';
                    return;
                }

                Array.from(banks).sort().forEach(bankName => {
                    const bankAccounts = accounts.filter(acc => acc.bank_name && acc.bank_name.trim() === bankName);
                    const div = document.createElement('div');
                    div.className = 'bank-item';
                    div.innerHTML = `
                        <div class="bank-info">
                            <h4>${bankName}</h4>
                            <p>${bankAccounts.length} account${bankAccounts.length !== 1 ? 's' : ''}</p>
                        </div>
                        <div class="bank-actions">
                            <button class="btn btn-secondary btn-small" onclick="deleteBank('${bankName}')" title="Delete Bank">
                                <i class="fas fa-trash"></i> Delete Bank
                            </button>
                        </div>
                    `;
                    banksList.appendChild(div);
                });
            }
        }

        async function createBank() {
            const bankName = document.getElementById('newBankName').value.trim();
            const bankDescription = document.getElementById('newBankDescription').value.trim();
            
            if (!bankName) {
                showMessage('Please enter a bank name', 'error');
                return;
            }

            if (banks.has(bankName)) {
                showMessage('Bank already exists', 'error');
                return;
            }

            // Add to banks set
            banks.add(bankName);
            
            // Clear form
            document.getElementById('newBankName').value = '';
            document.getElementById('newBankDescription').value = '';
            
            // Update UI
            updateBankSelector();
            updateBanksList();
            createBankTabs();
            
            showMessage(`Bank "${bankName}" created successfully`, 'success');
        }

        async function deleteBank(bankName) {
            const bankAccounts = accounts.filter(acc => acc.bank_name && acc.bank_name.trim() === bankName);
            
            if (bankAccounts.length > 0) {
                const confirmDelete = confirm(`This bank has ${bankAccounts.length} account(s). Deleting the bank will also delete all its accounts. Are you sure?`);
                if (!confirmDelete) return;
                
                // Delete all accounts for this bank
                for (const account of bankAccounts) {
                    await deleteAccountFromServer(account.id);
                }
            } else {
                const confirmDelete = confirm(`Are you sure you want to delete "${bankName}"?`);
                if (!confirmDelete) return;
            }

            // Remove from banks set
            banks.delete(bankName);
            
            // Reload data to refresh UI
            await loadDashboardData();
            
            showMessage(`Bank "${bankName}" deleted successfully`, 'success');
        }

        async function deleteAccount(accountId, accountName) {
            const confirmDelete = confirm(`Are you sure you want to delete "${accountName}"?`);
            if (!confirmDelete) return;

            await deleteAccountFromServer(accountId);
            await loadDashboardData();
            showMessage(`Account "${accountName}" deleted successfully`, 'success');
        }

        async function deleteAccountFromServer(accountId) {
            try {
                let token = localStorage.getItem('authToken');
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }

                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete account');
                }
            } catch (error) {
                showMessage('Error deleting account: ' + error.message, 'error');
                throw error;
            }
        }

        function getBankGroups() {
            const bankGroups = {};
            accounts.forEach(account => {
                const bankName = account.bank_name || 'Unknown Bank';
                if (!bankGroups[bankName]) {
                    bankGroups[bankName] = [];
                }
                bankGroups[bankName].push(account);
            });
            return bankGroups;
        }

        function updateFilterSelects() {
            const filterSelect = document.getElementById('filterAccount');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">All Accounts</option>';
                accounts.forEach(account => {
                    filterSelect.innerHTML += `<option value="${account.id}">${account.name} (${account.bank_name})</option>`;
                });
            }
        }

        function updateTransactionsUI() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(transaction.date).toLocaleDateString()}</td>
                    <td>${transaction.description}</td>
                    <td>${transaction.account_name || 'Unknown'}</td>
                    <td>
                        <select class="category-select" onchange="updateTransactionCategory(${transaction.id}, this.value)">
                            <option value="${transaction.category}">${transaction.category}</option>
                        </select>
                    </td>
                    <td class="${transaction.amount < 0 ? 'text-red' : 'text-green'}">
                        $${Math.abs(parseFloat(transaction.amount)).toFixed(2)}
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="editTransaction(${transaction.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateBudgetUI() {
            const tbody = document.getElementById('budgetTableBody');
            tbody.innerHTML = '';
            
            budgetCategories.forEach(category => {
                const spent = calculateSpentForCategory(category.name);
                const remaining = category.budgeted_amount - spent;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td>$${parseFloat(category.budgeted_amount).toFixed(2)}</td>
                    <td>$${spent.toFixed(2)}</td>
                    <td class="${remaining < 0 ? 'text-red' : 'text-green'}">
                        $${remaining.toFixed(2)}
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="editBudgetCategory(${category.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateActualBudgetUI() {
            const tbody = document.getElementById('actualBudgetTableBody');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(transaction.date).toLocaleDateString()}</td>
                    <td>${transaction.description}</td>
                    <td>$${Math.abs(parseFloat(transaction.amount)).toFixed(2)}</td>
                    <td>${transaction.category}</td>
                    <td>
                        <select class="category-select" id="newCategory_${transaction.id}">
                            ${budgetCategories.map(cat => 
                                `<option value="${cat.name}" ${cat.name === transaction.category ? 'selected' : ''}>${cat.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <button class="btn" onclick="updateTransactionCategory(${transaction.id})">
                            <i class="fas fa-save"></i> Update
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAnalytics() {
            // Calculate metrics
            const totalBalance = accounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const monthlyIncome = monthlyTransactions
                .filter(t => parseFloat(t.amount) > 0)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
            const monthlyExpenses = Math.abs(monthlyTransactions
                .filter(t => parseFloat(t.amount) < 0)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0));
            
            // Update UI
            document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;
            document.getElementById('monthlyIncome').textContent = `$${monthlyIncome.toFixed(2)}`;
            document.getElementById('monthlyExpenses').textContent = `$${monthlyExpenses.toFixed(2)}`;
            
            // Update charts
            updateCharts();
        }

        function updateCharts() {
            // Spending trends chart
            const spendingCtx = document.getElementById('spendingChart').getContext('2d');
            if (charts.spending) charts.spending.destroy();
            
            charts.spending = new Chart(spendingCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Expenses',
                        data: [1200, 1100, 1300, 1000, 1250, 1150],
                        borderColor: '#D2691E',
                        backgroundColor: 'rgba(210, 105, 30, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#FDF5E6' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#FDF5E6' } },
                        y: { ticks: { color: '#FDF5E6' } }
                    }
                }
            });
            
            // Category breakdown chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (charts.category) charts.category.destroy();
            
            charts.category = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Office Supplies', 'Utilities', 'Maintenance', 'Services'],
                    datasets: [{
                        data: [300, 500, 200, 400],
                        backgroundColor: ['#D2691E', '#CD853F', '#A0522D', '#8B4513']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#FDF5E6' }
                        }
                    }
                }
            });
        }

        // Helper functions
        function calculateSpentForCategory(categoryName) {
            return transactions
                .filter(t => t.category === categoryName && parseFloat(t.amount) < 0)
                .reduce((sum, t) => sum + Math.abs(parseFloat(t.amount)), 0);
        }

        async function updateTransactionCategory(transactionId, newCategory) {
            if (!newCategory) {
                newCategory = document.getElementById(`newCategory_${transactionId}`).value;
            }
            
            try {
                let token = localStorage.getItem('authToken');
                if (!token) {
                    token = 'mock-token';
                    localStorage.setItem('authToken', token);
                }
                
                const response = await fetch(`/api/transactions/${transactionId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category: newCategory })
                });
                
                if (response.ok) {
                    showMessage('Transaction category updated', 'success');
                    loadDashboardData();
                } else {
                    throw new Error('Failed to update category');
                }
            } catch (error) {
                showMessage('Error updating category: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            // Create and show message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        // Filter functions
        function filterTransactions() {
            // Implementation for filtering transactions
            console.log('Filtering transactions...');
        }

        function editTransaction(id) {
            console.log('Editing transaction:', id);
        }

        function editBudgetCategory(id) {
            console.log('Editing budget category:', id);
        }
    </script>
</body>
</html> 